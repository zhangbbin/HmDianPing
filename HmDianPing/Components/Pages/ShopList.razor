@page "/shops"
@rendermode InteractiveServer
@using HmDianPing.Web.Models
@using HmDianPing.Web.Services
@using HmDianPing.Components.Shared
@inject ShopService ShopService

@inject IJSRuntime JS

<PageTitle>黑马点评 - 店铺列表</PageTitle>

<div class="container mt-4">
    <div class="row align-items-center mb-4">
        <div class="col-md-3">
            <h3 class="mb-0">🔥 热门店铺推荐</h3>
        </div>

        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="搜索店铺名称或商圈..."
                       @bind-value="searchText"
                       @onkeydown="HandleEnter" />

                <button class="btn btn-primary" @onclick="SearchShops">搜索</button>
            </div>
        </div>

        <div class="col-md-3 text-end">
            <a href="/shop/create" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> 新增店铺
            </a>
        </div>
    </div>

    @if (shops == null)
    {
        <div class="alert alert-info">正在加载美味数据...</div>
    }
    else if (shops.Count == 0)
    {
        <div class="alert alert-warning">
            没有找到关于 "<strong>@searchText</strong>" 的店铺，换个词试试？
            <button class="btn btn-link p-0" @onclick="ClearSearch">清除搜索</button>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var shopItem in shops)
            {
                <div class="col-md-4 mb-4">
                    <ShopCard Shop="shopItem" OnDeleteClick="DeleteShop" />
                </div>
            }
        </div>

        @if (TotalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">上一页</button>
                    </li>

                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        // 只显示第一页、最后一页、以及当前页的前后2页
                        if (i == 1 || i == TotalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                        {
                            var pageNumber = i;
                            <li class="page-item ...">...</li>
                        }
                        else if (i == currentPage - 3 || i == currentPage + 3)
                        {
                            // 显示省略号
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">下一页</button>
                    </li>
                </ul>
            </nav>
            <div class="text-center text-muted small mb-5">
                共 @totalCount 条记录，当前第 @currentPage / @TotalPages 页
            </div>
        }
    }

    
</div>

@code {
    private List<Shop>? shops;

    // 新增：搜索关键词变量
    private string searchText = "";

    // 新增：分页状态变量
    private int currentPage = 1;
    private int pageSize = 16; // 每页显示 6 个
    private int totalCount = 0;

    // 计算总页数 (向上取整)
    private int TotalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    // 将加载数据的逻辑抽取出来，方便复用
    private async Task LoadData()
    {
        // 调用 Service，传入当前页码
        var result = await ShopService.GetAllShopsAsync(searchText, currentPage, pageSize);

        // 解包结果
        shops = result.Items;
        totalCount = result.TotalCount;
    }

    // 新增：点击搜索按钮的方法
    private async Task SearchShops()
    {
        // ⚠️ 搜索时，必须重置回第 1 页，否则可能搜不到数据
        currentPage = 1;
        // 重新加载数据，LoadData 会读取最新的 searchText
        await LoadData();
    }

    // 新增：处理键盘回车事件 (提升用户体验)
    private async Task HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchShops();
        }
    }

    // 新增：清除搜索
    private async Task ClearSearch()
    {
        searchText = "";
        await LoadData();
    }

    private async Task DeleteShop(long id)
    {
        // 1. 调用浏览器的 confirm 弹窗
        // InvokeAsync<bool> 表示我们要获取 JS 函数的返回值（true/false）
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "⚠️ 高能预警\n\n确定要删除这家店铺吗？此操作无法撤销！");

        // 2. 如果用户点击了“确定” (true)
        if (confirmed)
        {
            // 调用后端删除
            await ShopService.DeleteShopAsync(id);

            // 3. 重新加载列表，让被删掉的卡片消失
            await LoadData();
        }
    }

    // 新增：换页方法
    private async Task ChangePage(int page)
    {
        // 防止越界
        if (page < 1 || page > TotalPages) return;

        currentPage = page;
        await LoadData();
    }
}
